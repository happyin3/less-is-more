# 系统设计

> 宏观、微观

## 方法论

1. 本质论（15个字概括出事务本质，高并发：有限的资源应对大量的请求）
2. 矛盾论（矛盾是推动事物不断发展的动力）
3. 系统论（各要素、多维度，从矛盾双方出发思考问题）
4. 演进论（事物是进化的）

## 宏观

1. 系统具体要求
2. 系统发展假设预测
3. 系统抽象设计
4. 系统详细设计
5. 迭代演化
6. 专题深入

## 系统具体要求

* 系统的目的（商业目的、商业用户、个人用户）
* 功能需求（核心功能，功能重要度排序）
* 非功能需求（性能指标）

## 系统发展假设预测

* 用户量
* 日活量
* 高峰并发量
* 流量（出口带宽）
* 内存
* 硬盘

## 系统抽象设计（大致架构）

* CDN
* 负载均衡
* 服务
* 存储
* 缓存
* 消息队列
* 异步任务
* 监控
* 日志

## 系统详细设计

* 数据结构与存储
* 核心服务设计
* 接口设计

## 迭代演化

## 高性能（响应时间、并发数、QPS、吞吐量、PV、UV、DAU）

* 读写高性能
* 读写分离
* 负载均衡（Nginx 30w+）
* 缓存（预热、浏览器缓存、读写分离、CDN缓存）（Redis 8w+）
* 异步
* 分片
* 分库分表
* 无锁
* 索引

### 高可用

* 集群
* 副本（分区）
* 超时重试
* 接口：降级、熔断、限流、排队

### 可扩展

* 无状态
* 分库分表
* 副本
* 集群
* 负载均衡（分流策略）

## 专题深入

* 高性能（批处理、磁盘顺序写、内存映射（MMAP）、零拷贝（sendfile）、写时复制（COW）、内存池、序列化协议、避免上下文切换、Reactor+epoll）
* 高可用（无单点故障、分布式共识、分布式事务、故障切换、快照）
* 可扩展（路由、一致性哈希、数据倾斜）
* 数据结构与算法（位图、跳跃表、B树、LSM、布隆过滤器、一致性哈希）
* 存储（SQL、NoSQL、索引、事务、分库分表、表设计、字段类型）
* 缓存（缓存一致性、雪崩、击穿、穿透、预热、大key、热key）
* 消息队列（消息重复消费、消息丢失、消息消费有序、消息堆积）
* RPC（序列化协议、通信协议、网络框架、服务治理（注册、调用））

## 微观

1. 功能模块划分
2. 子功能设计
3. 接口设计
    * 安全性（鉴权、调用频次）
    * 幂等性
    * 分页扩展
    * Restful
    * 并发
4. 编码
    * 设计思想（面向对象、面向接口、面向测试）
    * 设计原则（职责单一、开闭原则、里氏替换、接口隔离、依赖倒置、KISS、DRY、迪米特法则（高内聚、低耦合））
    * 设计模式
        * 单例、简单工厂、工厂、建造者（复杂的初始化过程，参数很多）
        * 代理、桥接、装饰器（增强功能）、适配器模式（设计缺陷的弥补）
        * 观察者模式、模板模式、策略模式、职责链模式、迭代器模式、状态模式
5. 重构
    * 代码质量问题
        * 可读
        * 可扩展
        * 可维护
        * 灵活
        * 简洁
        * 可复用
        * 可测试